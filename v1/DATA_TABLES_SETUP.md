# Система таблиц данных для цифровых двойников

## Описание

Система таблиц данных позволяет подключать структурированные данные к цифровым двойникам, что значительно улучшает качество их ответов. Двойники могут получать доступ к реальным данным и использовать их для более точных и информативных ответов.

## Возможности

- ✅ Создание таблиц с произвольной структурой
- ✅ Подключение таблиц к цифровым двойникам
- ✅ Настройка уровней доступа (чтение/запись/полный)
- ✅ Автоматическое обновление контекста двойника
- ✅ История запросов и аналитика
- ✅ Безопасное выполнение запросов
- ✅ Поддержка различных типов данных

## Установка

### 1. Импорт SQL миграции

Выполните SQL миграцию в вашей базе данных Supabase:

```sql
-- Файл: supabase/migrations/20250620000000_data_tables_integration.sql
-- Импортируйте содержимое этого файла в вашу базу данных
```

### 2. Проверка установки

После импорта в базе данных должны появиться следующие таблицы:

- `data_tables` - таблицы с данными
- `twin_data_table_connections` - связи между двойниками и таблицами
- `data_table_queries` - история запросов

### 3. Проверка функций

Убедитесь, что созданы следующие функции:

- `validate_table_schema(schema_data jsonb)` - валидация схемы таблицы
- `execute_data_table_query(p_table_id uuid, p_query_type text, p_query_data jsonb)` - выполнение запросов
- `get_twin_connected_tables(p_twin_id uuid)` - получение подключенных таблиц

## Использование

### 1. Создание таблицы

1. Перейдите в раздел "Таблицы данных" в боковом меню
2. Нажмите "Создать таблицу"
3. Заполните:
   - Название таблицы
   - Описание
   - Схему (колонки и типы данных)
4. Система автоматически создаст примеры данных

### 2. Подключение к двойнику

1. Откройте профиль двойника
2. Перейдите в раздел "Подключение таблиц"
3. Выберите таблицу для подключения
4. Настройте уровень доступа:
   - **Только чтение** - двойник может получать данные
   - **Чтение и запись** - двойник может изменять данные
   - **Полный доступ** - двойник может выполнять любые операции

### 3. Автоматическая интеграция

После подключения таблицы:
- Двойник автоматически получит информацию о структуре данных
- Системный промпт будет обновлен с информацией о доступных таблицах
- Двойник сможет использовать данные в своих ответах

## Типы данных

Поддерживаются следующие типы данных:

- `text` - Текстовые данные
- `integer` - Целые числа
- `numeric` - Числа с плавающей точкой
- `boolean` - Логические значения
- `date` - Даты
- `timestamp` - Дата и время

## Примеры использования

### Каталог товаров

```json
{
  "name": "Каталог товаров",
  "schema": [
    {"name": "name", "type": "text", "required": true},
    {"name": "price", "type": "numeric", "required": true},
    {"name": "category", "type": "text", "required": false},
    {"name": "in_stock", "type": "boolean", "required": true}
  ]
}
```

### База знаний

```json
{
  "name": "База знаний",
  "schema": [
    {"name": "question", "type": "text", "required": true},
    {"name": "answer", "type": "text", "required": true},
    {"name": "category", "type": "text", "required": false},
    {"name": "priority", "type": "integer", "required": false}
  ]
}
```

## Безопасность

- Все таблицы защищены Row Level Security (RLS)
- Пользователи могут управлять только своими таблицами
- Запросы выполняются через безопасные функции
- Ведется история всех операций

## API

### Создание таблицы

```typescript
import { DataTableService } from './services/dataTableService';

const table = await DataTableService.createTable({
  name: 'Моя таблица',
  description: 'Описание таблицы',
  table_schema: [
    { name: 'name', type: 'text', required: true },
    { name: 'value', type: 'integer', required: false }
  ],
  sample_data: [
    { name: 'Пример 1', value: 100 },
    { name: 'Пример 2', value: 200 }
  ],
  user_id: 'user_id'
});
```

### Подключение к двойнику

```typescript
await DataTableService.connectTableToTwin({
  twin_id: 'twin_id',
  table_id: 'table_id',
  access_level: 'read',
  description: 'Описание подключения'
});
```

### Выполнение запроса

```typescript
const result = await DataTableService.executeTableQuery('table_id', {
  query_type: 'select',
  query_data: { filters: { category: 'electronics' } }
});
```

## Мониторинг

Система ведет подробную статистику:

- Количество созданных таблиц
- Активные подключения к двойникам
- Количество выполненных запросов
- Время выполнения запросов
- История операций

## Устранение неполадок

### Ошибка "Table not found"
- Проверьте, что таблица существует
- Убедитесь, что у вас есть права доступа

### Ошибка "Access denied"
- Проверьте настройки RLS
- Убедитесь, что таблица принадлежит вам

### Ошибка "Invalid query type"
- Используйте только поддерживаемые типы запросов: select, insert, update, delete

## Поддержка

При возникновении проблем:

1. Проверьте логи в консоли браузера
2. Убедитесь, что все миграции выполнены
3. Проверьте права доступа к базе данных
4. Обратитесь к документации Supabase

## Обновления

Система таблиц данных будет регулярно обновляться с новыми возможностями:

- Поддержка более сложных запросов
- Интеграция с внешними источниками данных
- Расширенная аналитика
- Улучшенная безопасность 